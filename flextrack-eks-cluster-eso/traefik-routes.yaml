# ---------------------------------------------------
# 1. CORS MIDDLEWARE (Must be defined first)
# ---------------------------------------------------
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: cors-headers
  namespace: default
spec:
  headers:
    accessControlAllowMethods:
      - "GET"
      - "POST"
      - "PUT"
      - "DELETE"
      - "OPTIONS"
    accessControlAllowHeaders:
      - "*"
    # For testing, allow all. For prod, put your S3 URL here.
    accessControlAllowOriginListRegex:
      - ".*" 
    accessControlMaxAge: 100
    addVaryHeader: true

---
# ---------------------------------------------------
# 2. AUTH MIDDLEWARE
# ---------------------------------------------------
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: throttler-check
  namespace: default
spec:
  forwardAuth:
    address: "http://throttler-app.default.svc.cluster.local:8080/v1/ratelimit"
    trustForwardHeader: true

---
# ---------------------------------------------------
# 3. STRIP PREFIX MIDDLEWARES
# ---------------------------------------------------
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: strip-expenses
  namespace: default
spec:
  stripPrefix:
    prefixes:
      - "/expenses"

---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: strip-notifier
  namespace: default
spec:
  stripPrefix:
    prefixes:
      - "/notifier"

---
# ---------------------------------------------------
# 4. THE ROUTER (Updated to use CORS)
# ---------------------------------------------------
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: flextrack-route
  namespace: default
spec:
  entryPoints:
    - web
  routes:
    # Route for Expenses App
    - match: PathPrefix(`/expenses`)
      kind: Rule
      services:
        - name: expenses-app
          port: 8080
      middlewares:
        # ✅ CRITICAL CHANGE: Add cors-headers here!
        - name: cors-headers     # CORS enabled for frontend 
        - name: throttler-check  # Run rate limit check first
        - name: strip-expenses   # Then strip the path prefix

    # Route for Notifier App
    - match: PathPrefix(`/notifier`)
      kind: Rule
      services:
        - name: notifier-app
          port: 8080
      middlewares:
        # ✅ CRITICAL CHANGE: Add cors-headers here!
        - name: cors-headers     
        - name: throttler-check
        - name: strip-notifier